# ZKP Contract

Contract: `smart_contracts/Ethereum/ZkpContract/contracts/zkpContract.sol`

## Prerequisites

* [install pnpm](https://pnpm.io/installation)
* Install the dependencies (from `./smart_contracts/Ethereum/ZkpContract/`): `pnpm i`
* Node 18 (`nvm use 18`)

## Circuit 

The Noir-generated circuit is defined in `./smart_contracts/Ethereum/ZkpContract/circuits/src/main.nr`

If updated, the tests will fail until the third parameter of every call to `create_proof` is updated accordingly.

## Test the contract

From `./smart_contracts/Ethereum/ZkpContract/`:

```
pnpm run test
```

Check specifically: 

* `should verify a proof — valid proof`
* `should verify a proof — invalid proof`

### Notes

The verification tests are launched twice:

* First, to directly test the verifier contract — `Contract: ZkpVerifier`
* Second, to indirectly test the verification through the main contract — `Contract: ZkpContract`

For the purposes of tests related to `ZkpContract`, the verifying smart contract should NOT be compiled using `nargo codegen-verifier` (it does not generate a valid verifier). Instead:

1. Uncomment lines 23 to 25 in `smart_contracts/ethereum/ZkpContract/test/zkpVerifier.js`
2. Run the tests (`pnpm run test`): they will fail
3. Modify the smart contract, `smart_contracts/ethereum/ZkpContract/contracts/zkpVerifier.sol`, just generated by the test
    * Replace `TurboVerifier` with `ZkpVerifier`
    * Use scope variables if there is a Stack Too Deep error when compiling (see: [https://ethereum.stackexchange.com/a/84378](https://ethereum.stackexchange.com/a/84378)) (hint: `let intermediate := ...` → `{ let t0 := ... }`)
4. Comment lines 23 to 25 in `smart_contracts/ethereum/ZkpContract/test/zkpVerifier.js` (to disable the autogeneration of the smart contract)
5. Run the tests (`pnpm run test`): they should pass
